---
title: ""
subtitle: ""
author: ""
thanks: ""
date: "`r format(Sys.time(), '%d %B %Y')`"
abstract: ""
output:
  bookdown::pdf_document2:
toc: FALSE
bibliography: references.bib
---

```{r setup, include=FALSE}
#update.packages(ask = FALSE, checkBuilt = TRUE)
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(generator)
library(stringi)
```

# Introduction

# Data Description & Processing

## Data source and description
```{r include=FALSE}
#Retrieving Data
homicides_to <-
  opendatatoronto::search_packages("Homicides")%>%
  opendatatoronto::list_package_resources()%>%
  filter(id =="dceda37a-f6c2-4029-9f2a-8728df86654b") %>%
  select(id) %>%
  opendatatoronto::get_resource()
```

The original dataset titled "Police Annual Statistical Report - Homicides" is retrieved from the Toronto Open Data Catalogue[@citeOpenDataToronto]. The full dataset contains 1093 observations and 13 variables. The dataset contains the following variables. All variables are in the character format."_id": unique row indentifier for open data database. "Index_": unique identifier of each occurrence in police report. "Event_Unique_ID": General Occurence Number. "Occurence_year": Year Homicide Occurred. "Division": Police Division where Homicide Occurred. "Homicide_Type": Type of Homicide. "Occurrence_Date": Date Homicide Occurred. Hood_ID: Identificator of Identificator of Neighbourhood where Homicide Occurred. "Neighbourhood": Name of Neighbourhood where Homicide Occurred. "Lat": Latitude Coordinates (Offset to nearest intersection). "Long": Longitude Coordinates (Offset to nearest intersection). "ObjectID": Autogenerated unique record identifier[@citeTorontoHomicide]. "geometry": not identified on the official dataset website. Missing values and null values that are not filed are presented in the dataset as empty (NA). 

According to Toronto Open Data Catalogue, observations included in this dataset are reported by the police on an annual basis. Since the dataset was directly translated from police reports, it contains consistent format and creditable value for each observation. However, there are different variables that could potentially cause bias in our research results. The location of each homicide occurence is offset to the nearest road intersection to protect the privacy of parties involved[@citeTorontoHomicide]. The offset reduces the accuracy of the research results which removes the possible fairness from overall dataset[@citeAIBias]. Timing of each occurence was not generated to one or two fixed time of each day. It is either a result of missing information or a result of imperfect processes[@citeAIBias]. The Lat column contains all missing value  which reduced value of the dataset and forced the Long variable to be removed from our analysis. This can also be caused by imperfect processes[@citeAIBias] either by a machine or human. These missing data and offsets increase bias towards our research results by potentially causing the research to wrongly identify certain neighbourhoods as "dangerous" while events, timing and location are offsetted. The rest of the dataset is filled with valid values in a consistent format. Some of the variable names such as "Division" and "Hood_ID" can be ambiguous.

## Data cleaning and renaming
```{r include=FALSE}
#Detect if there is any null or missing value in any of the columns
is.null(homicides_to)
apply(homicides_to, 2, function(x) any(is.na(x)))
summary(homicides_to)
```

In order to better analyze the dataset, the original dataset was duplicated for us to manipulate. Since our goal is to evaluate safety levels in different Toronto neighbourhoods, the columns that contains IDs, indexes and locations are removed. Removed columns include: Index_, Event_Unique_ID, Lat, Long, ObjectID and geometry. The ambiguous variable names are updated for easy reading. The "Hood_ID" variable name is updated to "Neighbourhood_ID". The "Division" variable name is updated to "Police_Division". 

```{r include=FALSE}
homicides_working_file <- homicides_to[, -c(1:3, 10:13)]
homicides_working_file$geometry <- NULL
homicides_working_file <- homicides_working_file %>% 
  rename(
    NeighbourHood_ID = Hood_ID,
    Police_Division = Division
  )
```


## Data formatting
Besides presented information in the working dataset. The month and date, or even hours can be helpful in our analysis process. Therefore, the variable "Occurrence_Date" is parsed and separated into three different variables: Occurence_Month, Occurence_Date and Occurence_Time. Also, to prepare the dataset for analysis and plotting, each variable is converted to its functional type. The modified dataset contains all categorical data. Occurrence_year contains 16 levels - each level from 2004 to 2019. Police_Division contains 17 levels from D11 to D55. Occurence_Month contains 12 levels. Occurence_Date contains 31 levels. Occurrence_Hour contains 2 levels - 04 and 05. Neighbourhood_ID contains 134 levels from 1 to 140. Neighbourhood contains 134 levels that features each neighbourhood name. Homicide_Type contains 3 levels - Shooting, Stabbing and Other.

```{r include=FALSE}
#Parse Date string into 3 different variables.
homicides_working_file <- separate(homicides_working_file, "Occurrence_Date", c("Occurrence_Date", "Occurrence_Time"), sep = "T")
homicides_working_file <- separate(homicides_working_file, "Occurrence_Date", c("Occurrence_Year2", "Occurrence_Month", "Occurrence_Date"), sep = "-")
homicides_working_file <- homicides_working_file[, -4] #Remove the extra year
homicides_working_file <- separate(homicides_working_file, "Occurrence_Time", c("Occurrence_Hour", "Occurrence_Minute", "Occurrence_Second"), sep = ":")
homicides_working_file <- homicides_working_file[, -c(7:8)] #Remove minutes and hours

#Convert variable types
homicides_working_file$Occurrence_year <- as.factor(homicides_working_file$Occurrence_year)
homicides_working_file$Police_Division <- as.factor(homicides_working_file$Police_Division)
homicides_working_file$Homicide_Type <- as.factor(homicides_working_file$Homicide_Type)
homicides_working_file$NeighbourHood_ID <- as.factor(homicides_working_file$NeighbourHood_ID)
homicides_working_file$Neighbourhood <- as.factor(homicides_working_file$Neighbourhood)
homicides_working_file$Occurrence_Month <- as.factor(homicides_working_file$Occurrence_Month)
homicides_working_file$Occurrence_Date <- as.factor(homicides_working_file$Occurrence_Date)
homicides_working_file$Occurrence_Hour <- as.factor(homicides_working_file$Occurrence_Hour)

#Check levels of each variable
lapply(homicides_working_file,levels)
```

```{r example, fig.cap="Sample of updated homicide dataset", echo = FALSE}

kbl(head(homicides_working_file), longtable = T, booktabs = T, caption = "Head of updated homicide dataset") %>%
kable_styling(full_width = T, font_size = 7) 

```


# Discussion

## Recorded types of homicide

As discovered in the previous observations, there are only 3 types of homicides that are features in this dataset - Shooting, Stabbing and Other. This is inconsistent among other literatures and researches. CP24 Toronto Crime map[@citeCrimeMap] features a wider range of homicide types which separate homicide from shooting. The Canadian law identified three types of homicide: murder, manslaughter and infanticide[@citeCanadianLaw]. The categories provided in this dataset does not match to lawful categories of homicide in Canada. As identified by Canadian law, homicide could also include hijacking, sexual offences or kidnapping[@citeCanadianLaw]. As shown in Figure 1: Type of homicide, although the sum of each type of homicide in the past 15 years shows that the category "Other" is ranked second. The Toronto Open Databased provides no further information regarding the inclusion of category "Other".  

```{r homicidetypes, fig.cap="Type of homicide", echo = FALSE}
ggplot(data=homicides_working_file, aes(Homicide_Type)) + 
  geom_bar()
```

## Recorded time of each occurence

Occurence hours are all documented at 4am or 5am in the morning. As mentioned in the Toronto Open Data Catalogue, the time of occurence does not represent the actual time of event. When mapping the occurence hours against occurence month in Figure 2, it becomes clear that the times of each event are all offset to a fixed hour of the day depending on daylight saving time. The events are recorded to happen at 5am between approximately November and April in the winter, then recorded to happen at 4am between April and November in the summer. 

```{r homicidetimes, fig.cap="Homicide occurence over hours by month between 2004 - 2019", echo = FALSE}
ggplot(data=homicides_working_file, aes(x = Occurrence_Month, y = Occurrence_Hour)) + 
  geom_point(alpha = 0.2, color= "blue")
```


# Analysis
## High occurrence month

In this section, the research aims to find out the months that have the highest occurence of homicides. Figure 3 shows the sum of homicides in all Toronto neighbourhood each month in the past 15 years. There is an even spread of homicide frequence through the year. Visually, the plot shows that July marks the slight peak of the homicide frequency and March marks the valleys of homicide frequency. This observation is valid, however, the differences between each months are not identical - especially between higher peak months July - October.

```{r homicideoccurence, fig.cap="Homicide occurence monthly between 2004 - 2019", echo = FALSE}
ggplot(data=homicides_working_file, aes(Occurrence_Month)) + 
  geom_bar()
```

In order to verify the previous observation aiming to find high occurrence month, the original dataset will be duplicated and filtered to only include homicide frequency from each month that is above the average annual occurrence. First of all, outliers needs to be excluded to avoid any accidental peak records to inaccurately increase the mean. A table is extracted from the original dataset to include all homicide frequency per month per year. Then, through plotting the homicide frequency in a bar graph, it is noticable that there are outliers. This can also be verified through the boxplot. By excluding the 4 outliers which values are 13, the new dataset is ready to provide a trimmed mean which represents the average homicide number in the past 15 years (7.83). Finally, the data that contains homicide frequency per month below the average are excluded. The new plots of the remaining data can be seen in Figure 4. 

```{r include=FALSE}

# Find max and min and only show average per month
all_crime_my <- table(homicides_working_file$Occurrence_Month, homicides_working_file$Occurrence_year)

#Exclude outlier, get trimmed mean 
all_crime_freq_outliers <- boxplot(data.frame(all_crime_my)$Freq)$out
data.frame(all_crime_my)[-which(data.frame(all_crime_my)$Freq %in% all_crime_freq_outliers),]
clean_all_crime_freq <- data.frame(all_crime_my)[-which(data.frame(all_crime_my)$Freq %in% 
                                                         all_crime_freq_outliers),]

clean_all_crime_freq <- clean_all_crime_freq %>% 
  rename(
    Month = Var1,
    Year = Var2
  )

#Only keep data above mean
clean_all_crime_freq <- clean_all_crime_freq[clean_all_crime_freq$Freq > 
                                             mean(clean_all_crime_freq$Freq),]
```

```{r homfreqoutliersbar, fig.cap="Homicide frequency bar plot (2004 - 2019)", echo = FALSE}
ggplot(data=data.frame(all_crime_my), aes(Freq)) + 
  geom_bar() + labs(title = "Homicide frequency bar plot (2004 - 2019)")
```
```{r homfreqoutliersbox, fig.cap="Homicide frequency box plot (2004 - 2019)", echo = FALSE}
boxplot(data.frame(all_crime_my)$Freq, main="Homicide frequency box plot (2004 - 2019)")$out 
```

The updated dataset plots Figure 4 which verifies our observation above, we can verify that the peak months of homicide  are between summer months July and October (included) with a small peak in May. Without outliers, September becomes the peak of homicide occurrence. March is no longer the lowest occurence months taking the data only above average occurrence. April and June become the new lowest months of homicide occurrences.

```{r homfreqaboveaverage, fig.cap="Homicide frequency plots (above average 2004 - 2019)", echo = FALSE}
ggplot(data=data.frame(clean_all_crime_freq), aes(Month)) + 
  geom_bar()
```


## Find overall top 5 annual high and low occurrence neighbourhoods

In this section, the research aim to find out the 5 neighbourhoods in Toronto that have the highest and lowest occurence of homicides from 2004 - 2019. First of all, the original dataset is duplicated and include only neighbourhood information, annual frequency and occurrence year. Then, through summing all the frequencies from 2004 - 2019 per neighbourhood, a new table is produced that contains a new variable that matches each neighbourhood - numbers of homicide (per year). After sorting the table in decending order, the top five observations represents the highest occurrence of homicide in Toronto between 2004 - 2019 (Table 2). The bottom five observations represents the lowest occurence of homicide in Toronto between 2004 - 2019 (Table 3). The lowest observations are not limited to the five neighbourhood shown in the table considering there are other neighbourhoods that also have 1 occurrence between 2004 - 2019.

```{r include=FALSE}
all_crime_ny <- data.frame(table(homicides_working_file$Neighbourhood, homicides_working_file$Occurrence_year))
all_crime_ny <- all_crime_ny %>% 
  rename(
    Neighbourhood = Var1,
    Year = Var2
  )

#Sum all years number of crime by neighbourhood
all_crime_ny <- aggregate(all_crime_ny$Freq, by=list(Neighbourhood=all_crime_ny$Neighbourhood), FUN=sum)
all_crime_ny <- all_crime_ny %>% 
  rename(
    Num_of_crime = x,
  )

all_crime_ny <- all_crime_ny %>% arrange(desc(Num_of_crime))

all_crime_ny_tbh <- all_crime_ny %>% top_n(5)
all_crime_ny_tbl <- tail(all_crime_ny, 5)
```

```{r topfiveperyear, fig.cap="Highest homicide frequency neighbourhoods in Toronto (2004 - 2019)", echo = FALSE}
kbl(all_crime_ny_tbh, booktabs = T, caption = "Highest homicide frequency neighbourhoods in Toronto (2004 - 2019)") %>% kable_styling(full_width = T, font_size = 7) 
```
```{r lowfiveperyear, fig.cap="Lowest homicide frequency neighbourhoods in Toronto (2004 - 2019)", echo = FALSE}
kbl(all_crime_ny_tbl, booktabs = T, caption = "Lowest homicide frequency neighbourhoods in Toronto (2004 - 2019)") %>%
kable_styling(full_width = T, font_size = 7) 
```

## Find top 5 high occurrence neighbourhoods over years in the peak month (July)

In this section, the research aim to find out the 5 neighbourhoods in Toronto that have the highest occurence of homicides in the highest occurence month (July) from the original dataset 2004 - 2019. First of all, the original dataset is duplicated and include only all neighbourhood information in July. Then, through summing all the frequencies from 2004 - 2019 per neighbourhood, a new table is produced that contains a new variable that matches each neighbourhood - numbers of homicide. After sorting the table in decending order, the top five observations represents the highest occurrence of homicide in Toronto in July between 2004 - 2019 (Table 4). The table also shows (but not limited to) additional 4 neighbourhoods that has equal homicide frequencies. 

```{r include=FALSE}
all_crime_july <- homicides_working_file[homicides_working_file$Occurrence_Month == "07",]
all_crime_njuly <- data.frame(table(all_crime_july$Neighbourhood, all_crime_july$Occurrence_year))
all_crime_njuly <- all_crime_njuly %>% 
  rename(
    Neighbourhood = Var1,
    Year = Var2
  )

#Sum all years number of crime by neighbourhood
all_crime_njuly <- aggregate(all_crime_njuly$Freq, by=list(Neighbourhood=all_crime_njuly$Neighbourhood), FUN=sum)
all_crime_njuly <- all_crime_njuly %>% 
  rename(
    Num_of_crime = x,
  )

all_crime_njuly <- all_crime_njuly[all_crime_njuly$Num_of_crime > 0,]
all_crime_njuly <- all_crime_njuly %>% arrange(desc(Num_of_crime))
all_crime_njuly_tb <-top_n(all_crime_njuly, 5)
```

```{r topfiveinjuly, fig.cap="Highest homicide frequency neighbourhoods in July in Toronto (2004 - 2019)", echo = FALSE}
kbl(all_crime_njuly_tb, booktabs = T, caption = "Highest homicide frequency neighbourhoods in July in Toronto (2004 - 2019)") %>% kable_styling(full_width = T, font_size = 7) 
```





## Find top 5 high occurrence over years by police division

This section aims to find out the 5 police division in Toronto that have the highest and the lowest occurence of homicides from 2004 - 2019. First of all, a new table is extracted from the original dataset to include Police_Division, frequency of occurrence and Occurrence_Year. Then, through summing all the frequencies from 2004 - 2019 per police division, the modified table contains a new variable that matches each police division - numbers of homicide. After sorting the table in decending order, the top five observations represents the highest occurrence of homicide in Toronto police divisions between 2004 - 2019 (Table 5). The bottom five observations represents the lowest occurrence of homicide in Toronto police divisions between 2004 - 2019 (Table 6). 

```{r include=FALSE}
all_crime_pd <- data.frame(table(homicides_working_file$Police_Division, homicides_working_file$Occurrence_year))

all_crime_pd <- all_crime_pd %>% 
  rename(
    Division = Var1,
    Year = Var2
  )

#Sum all years number of crime by police division
all_crime_pd <- aggregate(all_crime_pd$Freq, by=list(Division=all_crime_pd$Division), FUN=sum)

all_crime_pd <- all_crime_pd %>% 
  rename(
    Num_of_crime = x,
  )

all_crime_pd <- all_crime_pd %>% arrange(desc(Num_of_crime))

all_crime_pd_tbh <-top_n(all_crime_pd, 5)
all_crime_pd_tbl <-tail(all_crime_pd, 5)
```

```{r highfiveperyearpd, fig.cap="Highest homicide frequency police division in Toronto (2004 - 2019)", echo = FALSE}
kbl(all_crime_pd_tbh, booktabs = T, caption = "Highest homicide frequency police division in Toronto (2004 - 2019)") %>% kable_styling(full_width = T, font_size = 7) 
```
```{r lowfiveperyearpd, fig.cap="Lowest homicide frequency police division in Toronto (2004 - 2019)", echo = FALSE}
kbl(all_crime_pd_tbl, booktabs = T, caption = "Lowest homicide frequency police division in Toronto (2004 - 2019)") %>%
kable_styling(full_width = T, font_size = 7) 
```

# Results
Through observations and analysis, it is noticable that some of the neighbourhoods repetitively appear in the highest homicide frequency table over years and in the highest homicide frequency table in the peak months from 2004 - 2019. As a result of cross referencing the table results, the research can conclude that, according to the Toronto homicide police open data, Moss Park (73) and Glenfield-Jane Heights (25) are the two neighbourhoods in Toronto that presents the most homicide threads between 2004 - 2019. The high frequency homicide occurrence period is summer months between July and October. 

Combine the police division table result with research on the police division map[@citePoliceDivisionMap] and Toronto neighbourhood map[@citeTorontoNeighbourhoodProfile], the top record Division 31 which has 123 occurrence is in charge of South of Steels Ave. W. and north of HWY 401 between Humber River and Canadian National Railway. This maps well to Glenfield-Jane Heights neighbourhoods. The second record Division 51 which has 104 occurrence is in charge of East of Youge St., West of Don Valley Parkways on the South of Bloor St. E.. This maps to Moss Park neighbourhood. 

# Weaknesses and next steps

## Weaknesses
This dataset does not specify all types of crimes that can be considered within the category of homicide. Also, it does not provide directions on how each police division is appointed and reponsible for each neighbourhood. Also, the dataset is lacking accurate event occurrence time. Instead, it identifies all occurrences in a fix time either 4am or 5am. The absense of these information reduces the depth of analysis results.

## Next Steps

It will be interesting to further investigate the dataset and possible patterns through separating the full dataset into three subsets according to type of homicide. Through investigating each type and its relationship to neighbourhoods, the research can further understand the type of risks that is involved in each neighbourhood. Through comparing the results to the results of the full dataset, the research can identify potential vulnerbility of each type of homicide existing in Toronto community. 

Furthermore, through mapping the police division over the neighbourhood, it helps to understand potential weak points in police assignments in regards to risks of homicide. 

Finally, if this dataset can be combined with some other datasets that features events or important dates, the research depth can increase. For example, our research shows that July - October are the peak months of homicide. If combined with another dataset featuring important dates, we may be able to find any association between homicide frequence and school years.

\newpage


# References

